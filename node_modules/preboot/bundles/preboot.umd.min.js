!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("rxjs/operators/take"),require("rxjs/operators/filter")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","rxjs/operators/take","rxjs/operators/filter"],t):t(e.preboot=e.preboot||{},e.ng.core,e.ng.common,e.Rx.operators,e.Rx.operators)}(this,function(e,t,o,n,r){"use strict";function i(e){for(var t=[],o=e.root,n=e.node,r=n;r&&r!==o.serverNode&&r!==o.clientNode;)t.push(r),r=r.parentNode;r&&t.push(r);for(var i=(n.nodeName||"unknown")+"_"+o.serverSelector,a=t.length-1;a>=0;a--)if((r=t[a]).childNodes&&a>0)for(var l=0;l<r.childNodes.length;l++)if(r.childNodes[l]===t[a-1]){i+="_s"+(l+1);break}return i}var a=new t.InjectionToken("PrebootNonce");function l(){return{prebootData:window.prebootData,prebootStarted:!1,getComputedStyle:window.getComputedStyle,document:document}}var c=function(){function e(){this.clientNodeCache={},this.replayStarted=!1}return e.prototype.setWindow=function(e){this.win=e},e.prototype.getWindow=function(){return this.win||(this.win=l()),this.win},e.prototype.replayAll=function(){var e=this;if(!this.replayStarted){this.replayStarted=!0;var t=this.getWindow().prebootData||{};(t.apps||[]).forEach(function(t){return e.replayForApp(t)}),this.cleanup(t)}},e.prototype.replayForApp=function(e){var t=this;e=e||{};try{var o=e.root||{},n=e.events||[],r=this.getWindow().document,i=o.clientSelector;null!=i&&(o.clientNode=r.querySelector(i)),n.forEach(function(o){return t.replayEvent(e,o)})}catch(e){console.error(e)}this.switchBuffer(e)},e.prototype.replayEvent=function(e,t){e=e||{};var o=(t=t||{}).event,n=t.node||{},r=t.nodeKey,i=this.findClientNode({root:e.root,node:n,nodeKey:r});i?(i.checked=n.checked,i.selected=n.selected,i.value=n.value,i.dispatchEvent(o)):console.warn("Trying to dispatch event "+o.type+" to node "+r+"\n        but could not find client node. Server node is: "+n)},e.prototype.switchBuffer=function(e){var t=(e=e||{}).root||{},o=t.serverNode,n=t.clientNode;if(n&&o&&o!==n&&"BODY"!==o.nodeName)try{var r=(0,this.getWindow().getComputedStyle)(o).getPropertyValue("display")||"block";o.remove?o.remove():o.style.display="none",n.style.display=r}catch(e){console.error(e)}},e.prototype.cleanup=function(e){var t=this,o=(e=e||{}).listeners||[],n=e.activeNode;null!=n&&setTimeout(function(){return t.setFocus(n)},1);for(var r=0,i=o;r<i.length;r++){var a=i[r];a.node.removeEventListener(a.eventName,a.handler)}var l=this.getWindow().document,c=l.body.querySelector("#prebootOverlay");if(c&&(c.remove?c.remove():null!==c.parentNode?c.parentNode.removeChild(c):c.style.display="none"),e.apps=[],this.clientNodeCache={},"function"==typeof CustomEvent){var s=new CustomEvent("PrebootComplete");l.dispatchEvent(s)}else console.warn("Could not dispatch PrebootComplete event.\n       You can fix this by including a polyfill for CustomEvent.")},e.prototype.setFocus=function(e){if(e&&e.node&&e.nodeKey){var t=this.findClientNode(e);if(t){t.focus();var o=e.selection;if(t.setSelectionRange&&o)try{t.setSelectionRange(o.start,o.end,o.direction)}catch(e){}}}},e.prototype.findClientNode=function(e){var t=(e=e||{}).node,o=e.root;if(!o||!o.serverNode||!o.clientNode)return null;var n=e.nodeKey||i(e);if(this.clientNodeCache[n])return this.clientNodeCache[n];var r=(t.className||"").replace("ng-binding","").trim(),a=t.tagName;t.id?a+="#"+t.id:r&&(a+="."+r.replace(/ /g,"."));var l=o.clientNode,c=l.querySelectorAll(a);c.length||(console.log("nothing found for "+a+" so using "+t.tagName),c=l.querySelectorAll(t.tagName));for(var s=c.length,u=0;u<s;u++){var d=c.item(u);if(i({root:o,node:d})===n)return this.clientNodeCache[n]=d,d}return 1===c.length?(this.clientNodeCache[n]=c[0],c[0]):(console.warn("No matching client node found for "+n+".\n       You can fix this by assigning this element a unique id attribute."),null)},e}();function s(e,t){u((t||window).prebootData={opts:e,listening:!0,apps:[],listeners:[]})}function u(e,t){((t||window).document||{}).body?d(e):setTimeout(function(){u(e)},10)}function d(e,t){var o=t||window;if(!o.prebootStarted){o.prebootStarted=!0;var n=o.document||{},r=(e.opts||{}).eventSelectors||[];e.overlay=p(n),(e.opts?f(n,e.opts):[]).forEach(function(t){var o={root:t,events:[]};e.apps&&e.apps.push(o),(r=r.map(function(e){return e.hasOwnProperty("replay")||(e.replay=!0),e})).forEach(function(t){return v(e,o,t)})})}}function p(e){var t=e.createElement("div");return t.setAttribute("id","prebootOverlay"),t.setAttribute("style","display:none;position:absolute;left:0;top:0;width:100%;height:100%;z-index:999999;background:black;opacity:.3"),e.body.appendChild(t),t}function f(e,t){var o=[];if(t.appRoot&&t.appRoot.length){[].concat(t.appRoot).forEach(function(e){return o.push({serverSelector:e})})}return o.forEach(function(o){o.serverNode=e.querySelector(o.serverSelector),o.clientSelector=o.clientSelector||o.serverSelector,o.clientSelector!==o.serverSelector?o.clientNode=e.querySelector(o.clientSelector):o.clientNode=t.buffer?g(o):o.serverNode,o.serverNode||console.log("No server node found for selector: "+o.serverSelector)}),o}function v(e,t,o){var n=t.root.serverNode;if(n){var r=n.querySelectorAll(o.selector);if(r)for(var i=function(n){var i=r.item(n);o.events.forEach(function(n){var r=h(e,o,t,i);i.addEventListener(n,r),e.listeners&&e.listeners.push({node:i,eventName:n,handler:r})})},a=0;a<r.length;a++)i(a)}}function h(e,t,o,n){var r=["keyup","keydown","focusin","mouseup","mousedown"],a=["INPUT","TEXTAREA"];return function(l){var c=o.root,s=l.type;if(n&&s){var u=t.keyCodes;if(u&&u.length)if(!u.filter(function(e){return l.which===e}).length)return;t.preventDefault&&l.preventDefault(),t.action&&t.action(n,l);var d=i({root:c,node:n});if(r.indexOf(s)>=0&&a.indexOf(n.tagName?n.tagName:"")>=0?e.activeNode={root:c,node:n,nodeKey:d,selection:y(n)}:"change"!==s&&"focusout"!==s&&(e.activeNode=void 0),t.freeze){var p=e.overlay;p.style.display="block",setTimeout(function(){p.style.display="none"},1e4)}t.replay&&o.events.push({node:n,nodeKey:d,event:l,name:s})}}}function y(e){var t=(e=e||{}).value||"",o={start:t.length,end:t.length,direction:"forward"};try{(e.selectionStart||0===e.selectionStart)&&(o.start=e.selectionStart,o.end=e.selectionEnd?e.selectionEnd:0,o.direction=e.selectionDirection?e.selectionDirection:"")}catch(e){}return o}function g(e){var t=e.serverNode;if(!t||!t.parentNode||"html"===e.serverSelector||"body"===e.serverSelector)return t;var o=t.cloneNode(!1);return o.style.display="none",t.parentNode.insertBefore(o,t),t.setAttribute("ng-non-bindable",""),o}var m={waitUntilReady:u,start:d,createOverlay:p,getAppRoots:f,handleEvents:v,createListenHandler:h,getSelection:y,createBuffer:g},N={buffer:!0,minify:!0,replay:!0,eventSelectors:[{selector:"input,textarea",events:["keypress","keyup","keydown","input","change"]},{selector:"select,option",events:["change"]},{selector:"input",events:["keyup"],preventDefault:!0,keyCodes:[13],freeze:!0},{selector:"form",events:["submit"],preventDefault:!0,freeze:!0},{selector:"input,textarea",events:["focusin","focusout","mousedown","mouseup"],replay:!1},{selector:"button",events:["click"],preventDefault:!0,freeze:!0}]};function b(){var e=[];for(var t in m)if(m.hasOwnProperty(t)){var o=m[t].toString().replace("common_1.","");e.push(o)}return e.push(i.toString()),"\n\n"+e.join("\n\n")+"\n\n"}function w(e){var t=E({},N,e);S(t);var o=C(t);return"(function() {\n      "+b()+"\n      ("+s.toString().replace("common_1.","")+"\n      )("+o+")\n    })()"}function S(e){if(!e.appRoot||!e.appRoot.length)throw new Error("The appRoot is missing from preboot options. This is needed to find the root of your application. Set this value in the preboot options to be a selector for the root element of your app.")}function E(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=0;r<t.length;r++){var i=t[r];if(void 0!==i&&null!==i)for(var a in i)i.hasOwnProperty&&i.hasOwnProperty(a)&&(n[a]=i[a])}return n}function C(e){for(var t,o,n="START_FUNCTION_HERE",r="STOP_FUNCTION_HERE",i=JSON.stringify(e,function(e,t){return t&&t.constructor&&t.call&&t.apply?n+t.toString()+r:t}),a=i.indexOf(n);a>=0;)t=i.indexOf(r),o=(o=i.substring(a+n.length,t)).replace(/\\n/g,"\n"),a=(i=i.substring(0,a-1)+o+i.substring(t+r.length+1)).indexOf(n);return i}var O="preboot-inline-script",R=new t.InjectionToken("PrebootOptions");function P(e,t,i,a,l,c){return function(){if(o.isPlatformServer(a)){var s=w(t),u=e.createElement("script");i&&(u.nonce=i),u.id=O,u.textContent=s;var d=e.querySelectorAll("#"+O);0===d.length?e.head.appendChild(u):d.length>0&&i&&(d[0].nonce=i)}o.isPlatformBrowser(a)&&((null==t.replay||t.replay)&&l.isStable.pipe(r.filter(function(e){return e}),n.take(1)).subscribe(function(){c.replayAll()}))}}var T={provide:t.APP_BOOTSTRAP_LISTENER,useFactory:P,deps:[o.DOCUMENT,R,[new t.Optional,new t.Inject(a)],t.PLATFORM_ID,t.ApplicationRef,c],multi:!0},k=function(){function e(){}return e.withConfig=function(t){return{ngModule:e,providers:[{provide:R,useValue:t}]}},e.decorators=[{type:t.NgModule,args:[{providers:[c,T]}]}],e.ctorParameters=function(){return[]},e}();e.getNodeKeyForPreboot=i,e.PREBOOT_NONCE=a,e._window=l,e.EventReplayer=c,e.init=s,e.waitUntilReady=u,e.start=d,e.createOverlay=p,e.getAppRoots=f,e.handleEvents=v,e.createListenHandler=h,e.getSelection=y,e.createBuffer=g,e.defaultOptions=N,e.getEventRecorderCode=b,e.getInlinePrebootCode=w,e.validateOptions=S,e.assign=E,e.stringifyWithFunctions=C,e.PrebootModule=k,e.ɵb=P,e.ɵa=R,e.ɵc=T,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=preboot.umd.min.js.map
